<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인스타그램 프로필</title>
    <!-- 사이드바 css -->
    <link rel="stylesheet" href="/sidebar/sidebar.css">
    <!-- 메뉴 css -->
    <link rel="stylesheet" href="/sidebar/menu.css">
    <!-- 공통 베이스 css -->
    <link rel="stylesheet" href="/base/base.css">

    <!-- profilePage css -->
    <link rel="stylesheet" href="/profilePage/profilePage.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-contents {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #262626;
            border-radius: 12px;
            width: 500px;
            max-height: 500px;
            overflow-y: auto;
        }
        .modal-header {
            padding: 10px 20px;
            border-bottom: 1px solid #363636;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-weight: bold;
        }
        .close-button {
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        .search-bar {
            padding: 10px 20px;
            border-bottom: 1px solid #363636;
        }
        .search-input {
            width: 100%;
            padding: 8px;
            border: none;
            background-color: #363636;
            color: #fff;
            border-radius: 8px;
        }
        .follower-list {
            padding: 0;
            margin: 0;
            list-style-type: none;
        }
        .follower-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #363636;
        }
        .follower-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .follower-info {
            flex-grow: 1;
        }
        .follower-username {
            font-weight: bold;
        }
        .follower-name {
            color: #8e8e8e;
            font-size: 14px;
        }
        .delete-button {
            background-color: transparent;
            border: none;
            color: #0095f6;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
    <!-- postDetail css -->
    <link rel="stylesheet" href="/postDetail/postDetail.css">

</head>
<body>
<!-- sidebar html 불러오기 -->
<div id="sidebar-container"></div>

<script>
    fetch('/sidebar/sidebar.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('sidebar-container').innerHTML = data;
        })
        .catch(error => console.error('Error loading sidebar:', error));
</script>
<!-- sidebar html 불러오기 끝 -->

<!-- 검색, 알림 기능 사이드바 -->
<div id="menu-container"></div>

<script>
    fetch('/sidebar/menu.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('menu-container').innerHTML = data;
        })
        .catch(error => console.error('Error loading menu:', error));
</script>

<script src="/sidebar/menu.js" type="text/javascript"></script>
<!-- 검색, 알림 기능 사이드바 끝-->
    <div class="container">
        <!-- post-detail html 불러오기 -->
        <div id="post-detail"></div>

        <script>
            fetch('/postDetail/postDetail.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('post-detail').innerHTML = data;
                })
                .catch(error => console.error('Error loading sidebar:', error));
        </script>
        <!-- post-detail html 불러오기 끝 -->

        <header class="profile-header">
            <img src="/placeholder.svg?height=150&width=150" alt="프로필 사진" class="profile-picture">
            <div class="profile-info">
                <h1 class="profile-username" th:text="${profile?.user_id?:_}">mysk423</h1>
                <div class="profile-actions">

                    <!-- 프로필 편집 버튼, 팔로우 버튼 -->
                    <button th:if="${session.loginMember.user_id == profile.user_id}" class="profile-button" onclick="ProfileEdit()">프로필 편집</button>
                    <script>
                        function ProfileEdit(){
                            location.href = "/profileEdit";
                        }
                    </script> <!-- 프로필 편집 이동 스크립트 -->

                    <th:block th:unless="${session.loginMember.user_id == profile.user_id}">
                        <button th:if="${isFollow}" class="profile-button" id="unfollow-button" th:onclick="Unfollow(/*[[${profile.user_id}]]*/)">팔로잉</button>
                        <button th:unless="${isFollow}" class="profile-button" id="follow-button" th:onclick="Follow(/*[[${profile.user_id}]]*/)">팔로우</button>
                    </th:block>

                    <!-- 보관된 스토리 보기, 메시지 보내기 -->
                    <button th:if="${session.loginMember.user_id == profile.user_id}" class="profile-button">보관된 스토리 보기</button>
                    <button th:unless="${session.loginMember.user_id == profile.user_id}" class="profile-button">메시지 보내기</button>
                    <svg aria-label="옵션" class="settings-icon" fill="#262626" height="24" viewBox="0 0 48 48" width="24">
                        <path d="M46.7 20.6l-2.1-1.1c-.4-.2-.7-.5-.8-1-.5-1.6-1.1-3.2-1.9-4.7-.2-.4-.3-.8-.1-1.2l.8-2.3c.2-.5 0-1.1-.4-1.5l-2.9-2.9c-.4-.4-1-.5-1.5-.4l-2.3.8c-.4.1-.8.1-1.2-.1-1.4-.8-3-1.5-4.6-1.9-.4-.1-.8-.4-1-.8l-1.1-2.2c-.3-.5-.8-.8-1.3-.8h-4.1c-.6 0-1.1.3-1.3.8l-1.1 2.2c-.2.4-.5.7-1 .8-1.6.5-3.2 1.1-4.6 1.9-.4.2-.8.3-1.2.1l-2.3-.8c-.5-.2-1.1 0-1.5.4L5.9 8.8c-.4.4-.5 1-.4 1.5l.8 2.3c.1.4.1.8-.1 1.2-.8 1.5-1.5 3-1.9 4.7-.1.4-.4.8-.8 1l-2.1 1.1c-.5.3-.8.8-.8 1.3V26c0 .6.3 1.1.8 1.3l2.1 1.1c.4.2.7.5.8 1 .5 1.6 1.1 3.2 1.9 4.7.2.4.3.8.1 1.2l-.8 2.3c-.2.5 0 1.1.4 1.5L8.8 42c.4.4 1 .5 1.5.4l2.3-.8c.4-.1.8-.1 1.2.1 1.4.8 3 1.5 4.6 1.9.4.1.8.4 1 .8l1.1 2.2c.3.5.8.8 1.3.8h4.1c.6 0 1.1-.3 1.3-.8l1.1-2.2c.2-.4.5-.7 1-.8 1.6-.5 3.2-1.1 4.6-1.9.4-.2.8-.3 1.2-.1l2.3.8c.5.2 1.1 0 1.5-.4l2.9-2.9c.4-.4.5-1 .4-1.5l-.8-2.3c-.1-.4-.1-.8.1-1.2.8-1.5 1.5-3 1.9-4.7.1-.4.4-.8.8-1l2.1-1.1c.5-.3.8-.8.8-1.3v-4.1c.4-.5.1-1.1-.4-1.3zM24 41.5c-9.7 0-17.5-7.8-17.5-17.5S14.3 6.5 24 6.5 41.5 14.3 41.5 24 33.7 41.5 24 41.5z"></path>
                    </svg>

                    <script>
                        <!-- 로그인 한 유저가 프로필 보고있는 유저를 unfollow-->
                        function Unfollow(targetUser) {
                            console.log("Unfollow: ", targetUser);
                            let xhr = new XMLHttpRequest();
                            let unFollowButton = document.getElementById("unfollow-button");
                            let followCountDOM = document.getElementById("followCount");

                            xhr.onload = function() {
                                if (xhr.status == 200) {
                                    unFollowButton.onclick = function() { Follow(targetUser) };
                                    unFollowButton.innerText = "팔로우";
                                    unFollowButton.id = "follow-button";

                                    let count = xhr.responseText;
                                    followCountDOM.innerText = count;
                                }
                            };

                            xhr.open('POST', '/UnFollow', true);
                            xhr.setRequestHeader('Content-Type', 'application/json');
                            xhr.send(JSON.stringify({ targetUser: targetUser }));
                        }

                        <!-- 로그인 한 유저가 프로필 보고있는 유저를 follow-->
                        function Follow(targetUser) {
                            console.log("Follow: ", targetUser);
                            let xhr = new XMLHttpRequest();
                            let followButton = document.getElementById("follow-button");
                            let followCountDOM = document.getElementById("followCount");

                            xhr.onload = function() {
                                if (xhr.status == 200) {
                                    followButton.onclick = function() { Unfollow(targetUser) };
                                    followButton.innerText = "팔로잉";
                                    followButton.id = "unfollow-button";

                                    let count = xhr.responseText;
                                    followCountDOM.innerText = count;
                                }
                            };

                            xhr.open('POST', '/Follow', true);
                            xhr.setRequestHeader('Content-Type', 'application/json');
                            xhr.send(JSON.stringify({ targetUser: targetUser }));
                        }
                    </script> <!-- 팔로우 스크립트 -->
                    <!-- 프로필 편집 버튼, 팔로우 버튼 끝 -->
                </div>
                <div class="profile-stats">
                    <div class="stat">
                        게시물 <span class="stat-value" th:text="${ postsCount?:_ }">1</span>
                    </div>
                    <div class="stat" onclick="loadFollowerModalContent()">
                        팔로워 <span id="followCount" class="stat-value" th:text="${ followCount?:_ }">28</span>
                    </div>
                    <div class="stat" onclick="loadFollowingModalContent()">
                        팔로우 <span class="stat-value" th:text="${ followingCount?:_ }">15</span>
                    </div>
                </div>

                <div class="profile-fullname" th:text="${ profile?.name?:_ }">문태성</div>
                <div class="profile-description" th:text="${ profile?.description?:_ }">문태성</div>
            </div>
        </header>
        <main class="gallery">
            <th:block th:each="post : ${posts}">
                <div class="gallery-item">
                    <img th:src="@{${post?.image_link?:_}}" alt="게시물 1">
                    <!-- TODO : 클릭하면 해당 게시글로 이동하게 만들어야 함. -->
                </div>
            </th:block>
        </main>
        <!-- Follower Modal Structure -->
        <div id="FollowerModal" class="modal">
            <div class="modal-content" id="FollowerModalContent">
            </div>
        </div>
        <!-- 팔로워 모달을 보여주는 스크립트 -->
        <script>
            function openFollowerModal() {
                document.getElementById("FollowerModal").style.display = "block";
            }

            function closeFollowerModal() {
                document.getElementById("FollowerModal").style.display = "none";
            }

            function loadFollowerModalContent() {
               let xhr = new XMLHttpRequest();

               xhr.onload = function() {
                   // 서버에서 받아온 HTML을 모달에 넣기
                   document.getElementById("FollowerModalContent").innerHTML = xhr.responseText;
                   // 모달 열기
                   openFollowerModal();
               };

               xhr.open("GET", "/getFollowerModalContent", true); // 서버에서 모달의 내용을 가져올 경로
               xhr.send();
            }

            <!-- searchbar change event -->
            function inputTextFollowInputEvent() {
       		let xhr = new XMLHttpRequest();
       		let userId = document.getElementById("search-input").value;
       		let targetId = '[[${ profile.user_id }]]';
       		xhr.onload = function() {
       			if (xhr.status == 200) {
       			    let search_section = document.getElementById("follower-list");
                    search_section.innerHTML = "";

                    if (xhr.responseText.length == 0){
                        return;
                    }

       			    let users = JSON.parse(xhr.responseText);

                    search_section.innerHTML = "";
                        users.forEach(user => {
                            search_section.innerHTML += `<li class="follower-item"><a href="http://localhost:8090/profile/${user.follower_id}"><div class="follower-info"><img src="/placeholder.svg?height=30&width=30" alt="User"><div class="follower-user_id">${user.follower_id}</div><div class="follower-name">${user.follower_id}</div></div></a><button class="delete-button">삭제</button></li>`;
                        });
       			    }
       		};
       		xhr.open('POST', '/profile/searchFollowerUser', true);
       		xhr.setRequestHeader('Content-Type', 'application/json');
       		xhr.send(JSON.stringify({ targetId: targetId, userId: userId }));
            }
        </script>

        <!-- Following Modal Structure -->
        <div id="FollowingModal" class="modal">
            <div class="modal-content" id="FollowingModalContent">
            </div>
        </div>

        <!-- 팔로잉 모달을 보여주는 스크립트 -->
        <!-- 팔로잉은 아직 만드는 중.... -->
        <script>
            function openFollowingModal() {
                document.getElementById("FollowingModal").style.display = "block";
            }

            function closeFollowingModal() {
                document.getElementById("FollowingModal").style.display = "none";
            }

            function loadFollowingModalContent() {
               let xhr = new XMLHttpRequest();

               xhr.onload = function() {
                   // 서버에서 받아온 HTML을 모달에 넣기
                   document.getElementById("FollowingModalContent").innerHTML = xhr.responseText;
                   // 모달 열기
                   openFollowingModal();
               };

               xhr.open("GET", "/getFollowingModalContent", true); // 서버에서 모달의 내용을 가져올 경로
               xhr.send();
            }

            <!-- searchbar change event -->
            function inputTextFollowingInputEvent() {
       		let xhr = new XMLHttpRequest();
       		let userId = document.getElementById("search-input").value;
       		let targetId = '[[${ profile.user_id }]]';
       		xhr.onload = function() {
       			if (xhr.status == 200) {
       			    let search_section = document.getElementById("follower-list");
                    search_section.innerHTML = "";

                    if (xhr.responseText.length == 0){
                        return;
                    }

       			    let users = JSON.parse(xhr.responseText);

                    search_section.innerHTML = "";
                        users.forEach(user => {
                            search_section.innerHTML += `<li class="follower-item"><a href="http://localhost:8090/profile/${user.following_id}"><div class="follower-info"><img src="/placeholder.svg?height=30&width=30" alt="User"><div class="follower-user_id">${user.following_id}</div><div class="follower-name">${user.following_id}</div></div></a><button class="delete-button">삭제</button></li>`;
                        });
       			    }
       		};
       		xhr.open('POST', '/profile/searchFollowingUser', true);
       		xhr.setRequestHeader('Content-Type', 'application/json');
       		xhr.send(JSON.stringify({ targetId: targetId, userId: userId }));
            }
        </script>
    </div>
</body>
</html>