<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--    <title th:text="${chatRoom.room_name} + ' - 채팅방'">채팅방</title>-->
    <title>채팅방</title>
    <script src="https://cdn.jsdelivr.net/sockjs/1.0.3/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-end;
            margin-bottom: 10px;
            max-width: 70%;
        }

        .message-wrapper.sent {
            align-self: flex-end;
        }

        .message-wrapper.received {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 10px;
            border-radius: 15px;
            max-width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-wrapper.sent .message-bubble {
            background-color: #0095f6;
            color: white;
            order: 2;
        }

        .message-wrapper.received .message-bubble {
            background-color: #333;
            color: white;
            order: 1;
        }

        .message-time {
            font-size: 0.8em;
            color: #888;
            margin: 0 5px;
            align-self: flex-end;
        }

        .message-wrapper.sent .message-time {
            order: 1;
        }

        .message-wrapper.received .message-time {
            order: 2;
        }

        .input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #333;
        }

        #messageInput {
            flex-grow: 1;
            padding: 10px;
            border: none;
            background-color: #333;
            color: #fff;
        }

        #sendButton {
            padding: 10px;
            background-color: #0095f6;
            color: white;
            border: none;
        }

        #default-content {
            display: none;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #262626;
        }
        .chat-info {
            margin-left: 15px;
        }
        .chat-username {
            font-weight: bold;
            font-size: 16px;
        }
        .chat-status {
            font-size: 12px;
            color: #8e8e8e;
        }
        .chat-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #262626;
        }
        .chat-top-avatar {
            width: 96px;
            height: 96px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .chat-top-username {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .profile-view-btn {
            background-color: #262626;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        .profile-view-btn:hover {
            background-color: #363636;
        }
        .small-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <div id="default-content" class="chat-area">
        <p>메시지를 선택하거나 새로운 메시지를 보내세요</p>
        <button class="new-message-btn" id="newMessageBtn">새 메시지</button>
    </div>
    <div class="chat-header">
        <img src="../img/안선생님.png" alt="상대방 이름" class="small-avatar">
        <div class="chat-info">
            <div class="chat-username" th:text="${name}">상대방 이름</div><!-- 여기 -->
            <div class="chat-status">Instagram</div>
        </div>
    </div>

    <div id="chatMessages" class="chat-area">
        <div class="chat-top">
            <img src="../img/안선생님.png" alt="상대방 이름" class="chat-top-avatar">
            <div class="chat-top-username" th:text="${name}">상대방 이름</div> <!-- 여기 -->
            <button class="profile-view-btn">프로필 보기</button>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
        <button id="sendButton">전송</button>
    </div>
</div>

<script th:inline="javascript">
    let stompClient = null;
    let roomId = getRoomIdFromUrl(); // URL에서 roomId를 추출
    const currentUserName = /*[[${name}]]*/ '[[${name}}]';
    let oldestMessageDate = new Date().toISOString();

    // URL에서 roomId를 추출하는 함수
    function getRoomIdFromUrl() {
        const url = new URL(window.location.href);
        const pathSegments = url.pathname.split('/');
        return pathSegments[pathSegments.length - 1]; // URL의 마지막 부분에서 roomId를 추출
    }

    // 웹소켓 연결 및 STOMP 클라이언트 설정
    function connect() {
        if (!roomId) {
            console.error('roomId를 찾을 수 없습니다.');
            return;
        }

        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame + ' as ' + currentUserName);

            // 채팅방 구독
            stompClient.subscribe('/topic/chatRoom/' + roomId, function (message) {
                const receivedMessage = JSON.parse(message.body);
                showMessage(receivedMessage);
            });
        }, function (error) {
            console.error('STOMP error: ' + error);
        });
    }

    function createMessageElement(message) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = message.sender.trim() === currentUserName.trim() ? 'message-wrapper sent' : 'message-wrapper received';

        const messageElement = document.createElement('div');
        messageElement.className = 'message-bubble';
        messageElement.textContent = message.message;

        const timeElement = document.createElement('div');
        timeElement.className = 'message-time';
        const messageDate = new Date(message.sendDate);
        timeElement.textContent = messageDate.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        messageWrapper.appendChild(messageElement);
        messageWrapper.appendChild(timeElement);

        return messageWrapper;
    }

    // 메시지 전송 함수
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const messageContent = messageInput.value;

        if (messageContent.trim() !== "" && stompClient && stompClient.connected) {
            const message = {
                type: 'TALK',
                sender: currentUserName,
                message: messageContent,
                roomId: roomId,
                sendDate: new Date().toISOString()
            };
            stompClient.send("/app/chat/message", {}, JSON.stringify(message));
            messageInput.value = '';
        } else {
            console.error("웹소켓이 연결되지 않았습니다.");
        }
    }

    let initialLoad = true; // 처음 로드인지 여부를 저장하는 변수

    // showMessage 함수 수정
    function showMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageElement = createMessageElement(message);

        // chat-top 아래에 메시지를 추가 (맨 위에 고정)
        chatMessages.appendChild(messageElement);

        // 스크롤 처리: 새 메시지가 추가되면 맨 아래로 스크롤
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function loadPreviousMessages() {
        const chatMessages = document.getElementById('chatMessages');
        const previousHeight = chatMessages.scrollHeight;

        fetch(`/chat/messages/previous?roomId=${roomId}&before=${oldestMessageDate}&limit=20`)
            .then((response) => {
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.json();
        })
            .then((data) => {
            if (data.length > 0) {
                const chatTop = chatMessages.querySelector('.chat-top');
                data.forEach(function (message) {
                    const messageElement = createMessageElement(message);
                    // 이전 메시지를 chat-top 아래에 추가
                    chatMessages.insertBefore(messageElement, chatTop.nextSibling);

                    const messageDate = new Date(message.sendDate);
                    if (!oldestMessageDate || messageDate < new Date(oldestMessageDate)) {
                        oldestMessageDate = message.sendDate;
                    }
                });

                chatMessages.scrollTop = chatMessages.scrollHeight - previousHeight;
            }
        })
            .catch((err) => console.error('Error loading previous messages:', err));
    }



    // 이벤트 리스너 설정 함수
    function setupEventListeners() {
        const sendButton = document.getElementById('sendButton');
        const messageInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        messageInput.addEventListener('input', function() {
            sendButton.disabled = this.value.trim() === '';
        });

        chatMessages.addEventListener('scroll', function() {
            if (chatMessages.scrollTop === 0) {
                loadPreviousMessages();
            }
        });
    }


    // DOM이 로드된 후 이벤트 리스너와 연결 설정
    document.addEventListener('DOMContentLoaded', function() {
        // 기본 메시지 숨김 처리 (기본적으로 숨겨두기)
        const defaultContent = document.getElementById('default-content');

        if (defaultContent) {
            defaultContent.style.display = 'none';
        }
        // 연결 함수 실행
        connect();
        loadPreviousMessages();
        setupEventListeners();
    });
</script>

<!-- chatRoom -->
</body>
</html>
