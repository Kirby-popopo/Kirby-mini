<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${chatRoom.room_name} + ' - 채팅방'">채팅방</title>
    <script src="https://cdn.jsdelivr.net/sockjs/1.0.3/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chat-header, .input-area {
            border-bottom: 1px solid #333;
            padding: 10px;
        }
        .small-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .chat-info {
            flex-grow: 1;
        }
        .chat-username {
            font-weight: bold;
        }
        .chat-status {
            font-size: 0.8em;
            color: #888;
        }
        .chat-top {
            text-align: center;
            padding: 20px 0;
        }
        .chat-top-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }
        .profile-view-btn {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
        }
        #chatMessages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            scrollbar-width: thin;
            scrollbar-color: #333 #000;
        }
        .message {
            max-width: 70%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 20px;
            clear: both;
        }

        .received {
            background-color: #333;
            float: left;
            border-radius: 20px 20px 20px 0;
        }

        .sent {
            background-color: #0095f6;
            float: right;
            border-radius: 20px 20px 0 20px;
        }
        .timestamp {
            font-size: 0.8em;
            color: #888;
            margin: 10px 0;
            text-align: center;
            clear: both;
        }
        .input-area {
            display: flex;
            padding: 10px;
        }
        #messageInput {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            background-color: #333;
            color: #fff;
            margin-right: 10px;
        }
        #sendButton {
            background-color: #0095f6;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <div class="chat-header">
            <img src="/placeholder.svg?height=40&width=40" th:alt="${chatRoom.room_name}" class="small-avatar">
            <div class="chat-info">
                <div class="chat-username" th:text="${chatRoom.room_name}">채팅방 이름</div>
                <div class="chat-status">Instagram</div>
            </div>
        </div>
        <div class="chat-top">
            <img src="/placeholder.svg?height=80&width=80" th:alt="${chatRoom.room_name}" class="chat-top-avatar">
            <div class="chat-top-username" th:text="${chatRoom.room_name}">채팅방 이름</div>
            <button class="profile-view-btn">프로필 보기</button>
        </div>
        <div id="chatMessages">
            <div id="messageList" th:each="message : ${messages}">
                <div th:if="${message.displayDate != null}" class="timestamp">
                    <strong th:text="${message.displayDate}"></strong>
                </div>
                <div th:class="${message.sender == '사용자 이름' ? 'message sent' : 'message received'}">
                    <span th:text="${message.sender} + ': ' + ${message.message}"></span>
                </div>
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
            <button id="sendButton" disabled>전송</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let stompClient = null;
    const roomId = /*[[${chatRoom.roomId}]]*/ '[[${chatRoom.roomId}]]'; // 채팅방 ID
    const currentUserName = 'User-' + Math.floor(Math.random() * 10000); // 임의의 사용자 이름 생성
    let oldestMessageDate = new Date().toISOString(); // 가장 오래된 메시지의 날짜

    // 웹소켓 연결 및 STOMP 클라이언트 설정
    function connect() {
        const socket = new SockJS('/ws-stomp'); // SockJS 인스턴스 생성
        stompClient = Stomp.over(socket); // STOMP 클라이언트 생성
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame + ' as ' + currentUserName);

            // 채팅방 구독
            stompClient.subscribe('/topic/chatRoom/' + roomId, function (message) {
                const receivedMessage = JSON.parse(message.body);
                showMessage(receivedMessage); // 수신된 메시지 화면에 표시
            });
        }, function (error) {
            console.error('STOMP error: ' + error); // 연결 실패 시 에러 로그 출력
        });
    }

    // 메시지 전송 함수
    function sendMessage() {
        const messageContent = document.getElementById('messageInput').value;

        // 메시지가 비어있지 않고 STOMP 클라이언트가 연결된 경우
        if (messageContent.trim() !== "" && stompClient && stompClient.connected) {
            const message = {
                type: 'TALK',
                sender: currentUserName, // 현재 사용자 이름(지금은 임시 유저)을 메시지에 포함
                message: messageContent,
                roomId: roomId,
                sendDate: new Date().toISOString() // 현재 시간 설정
            };
            stompClient.send("/app/chat/message", {}, JSON.stringify(message)); // 메시지 전송
            document.getElementById('messageInput').value = ''; // 입력 필드 비우기
        } else {
            console.error("웹소켓이 연결되지 않았습니다."); // 연결되지 않았을 때 에러 로그 출력
        }
    }

    // 메시지를 화면에 표시하는 함수
    function showMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const atBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 1;

        // 메시지 발신자에 따라 스타일 설정
        const messageElement = document.createElement('div');
        messageElement.className = message.sender === currentUserName ? 'message sent' : 'message received';

        // 시간 포맷팅
        const messageDate = new Date(message.sendDate);
        const formattedTime = messageDate.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });

        // 메시지 내용과 시간 표시
        messageElement.innerHTML = `<strong>${message.sender}</strong>: ${message.message} <br><small>${formattedTime}</small>`;
        chatMessages.appendChild(messageElement);

        // 메시지가 추가된 후 스크롤을 가장 아래로 이동 (사용자가 이미 아래에 있는 경우)
        if (atBottom) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // 이전 메시지를 불러오는 함수
    function loadPreviousMessages() {
        const chatMessages = document.getElementById('chatMessages');
        const previousHeight = chatMessages.scrollHeight;

        // AJAX 요청을 통해 이전 메시지 불러오기
        fetch(`/chat/messages/previous?roomId=${roomId}&before=${oldestMessageDate}&limit=20`)
            .then(response => response.json())
            .then(data => {
            if (data.length > 0) {
                data.forEach(function (message) {
                    const newMessage = document.createElement('div');

                    // 메시지 발신자에 따라 스타일 설정
                    newMessage.className = message.sender === currentUserName ? 'message sent' : 'message received';

                    // 시간 포맷팅
                    const messageDate = new Date(message.sendDate);
                    const formattedTime = messageDate.toLocaleTimeString('ko-KR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    // 메시지 내용과 시간 표시
                    newMessage.innerHTML = `<strong>${message.sender}</strong>: ${message.message} <br><small>${formattedTime}</small>`;
                    chatMessages.prepend(newMessage);

                    // 가장 오래된 메시지 날짜 갱신
                    if (!oldestMessageDate || messageDate < new Date(oldestMessageDate)) {
                        oldestMessageDate = message.sendDate;
                    }
                });

                // 이전 메시지를 로드한 후 스크롤 위치를 유지
                chatMessages.scrollTop = chatMessages.scrollHeight - previousHeight;
            }
        })
            .catch(err => console.error('이전 메시지를 가져오는 중 오류 발생:', err));
    }

    // DOM이 로드된 후 이벤트 리스너와 연결 설정
    document.addEventListener('DOMContentLoaded', function() {
        connect(); // 웹소켓 연결
        setupEventListeners(); // 이벤트 리스너 설정
    });

    // 이벤트 리스너 설정 함수
    function setupEventListeners() {
        const sendButton = document.getElementById('sendButton');
        const messageInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');

        // 전송 버튼 클릭 시 메시지 전송
        sendButton.addEventListener('click', sendMessage);
        // Enter 키를 누르면 메시지 전송
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        // 입력 필드 내용에 따라 전송 버튼 활성화/비활성화
        messageInput.addEventListener('input', function() {
            sendButton.disabled = this.value.trim() === '';
        });

        // 처음 로드 시 스크롤을 가장 아래로 이동
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // 스크롤이 상단에 도달했을 때 이전 메시지 로드
        chatMessages.addEventListener('scroll', function() {
            if (chatMessages.scrollTop === 0) {
                loadPreviousMessages();
            }
        });
    }
</script>


</body>
</html>
