<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--    <title th:text="${chatRoom.room_name} + ' - 채팅방'">채팅방</title>-->
    <title>채팅방</title>
    <script src="https://cdn.jsdelivr.net/sockjs/1.0.3/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .message {
            max-width: 70%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 20px;
            clear: both;
        }

        .received {
            background-color: #333;
            float: left;
            border-radius: 20px 20px 20px 0;
        }

        .sent {
            background-color: #0095f6;
            float: right;
            border-radius: 20px 20px 0 20px;
        }

        .input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid #333;
        }
        #messageInput {
            flex-grow: 1;
            padding: 10px;
            border: none;
            background-color: #333;
            color: #fff;
        }
        #sendButton {
            padding: 10px;
            background-color: #0095f6;
            color: white;
            border: none;
        }
    </style>
</head>
<body>
<div class="container">
    <div id="chatMessages" class="chat-area"></div>
    <div class="input-area">
        <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
        <button id="sendButton">전송</button>
    </div>
</div>

<script th:inline="javascript">
    let stompClient = null;
    let roomId = getRoomIdFromUrl(); // URL에서 roomId를 추출
    const currentUserName = 'User-' + Math.floor(Math.random() * 10000);
    let oldestMessageDate = new Date().toISOString();

    // URL에서 roomId를 추출하는 함수
    function getRoomIdFromUrl() {
        const url = new URL(window.location.href);
        const pathSegments = url.pathname.split('/');
        return pathSegments[pathSegments.length - 1]; // URL의 마지막 부분에서 roomId를 추출
    }

    console.log('Extracted roomId:', roomId); // roomId가 제대로 출력되는지 확인

    // 웹소켓 연결 및 STOMP 클라이언트 설정
    function connect() {
        if (!roomId) {
            console.error('roomId를 찾을 수 없습니다.');
            return;
        }

        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame + ' as ' + currentUserName);

            // 채팅방 구독
            stompClient.subscribe('/topic/chatRoom/' + roomId, function (message) {
                const receivedMessage = JSON.parse(message.body);
                showMessage(receivedMessage);
            });
        }, function (error) {
            console.error('STOMP error: ' + error);
        });
    }

    // 메시지 전송 함수
    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const messageContent = messageInput.value;

        if (messageContent.trim() !== "" && stompClient && stompClient.connected) {
            const message = {
                type: 'TALK',
                sender: currentUserName,
                message: messageContent,
                roomId: roomId,
                sendDate: new Date().toISOString()
            };
            stompClient.send("/app/chat/message", {}, JSON.stringify(message));
            messageInput.value = '';
        } else {
            console.error("웹소켓이 연결되지 않았습니다.");
        }
    }

    // 메시지를 화면에 표시하는 함수
    function showMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const atBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 1;

        // 메시지 발신자에 따라 스타일 설정
        const messageElement = document.createElement('div');
        messageElement.className = message.sender === currentUserName ? 'message sent' : 'message received';

        // 시간 포맷팅
        const messageDate = new Date(message.sendDate);
        const formattedTime = messageDate.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });

        // 메시지 내용과 시간 표시
        messageElement.innerHTML = `<strong>${message.sender}</strong>: ${message.message} <br><small>${formattedTime}</small>`;
        chatMessages.appendChild(messageElement);

        // 메시지가 추가된 후 스크롤을 가장 아래로 이동 (사용자가 이미 아래에 있는 경우)
        if (atBottom) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    fetch(`/chat/messages/previous?roomId=${roomId}&before=${oldestMessageDate}&limit=20`)
        .then(response => {
        console.log('Response:', response);
        return response.text(); // JSON 대신 plain text로 확인해 보기
    })
        .then(data => {
        console.log('Data received:', data);
    })
        .catch(err => console.error('Error occurred:', err));

    function loadPreviousMessages() {
        const chatMessages = document.getElementById('chatMessages');
        const previousHeight = chatMessages.scrollHeight;

        // fetch 요청을 통해 이전 메시지를 불러오기
        fetch(`/chat/messages/previous?roomId=${roomId}&before=${oldestMessageDate}&limit=20`)
            .then((response) => {
            // fetch 응답이 잘 왔는지 체크
            console.log('Fetch response status:', response.status);
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.json();
        })
            .then((data) => {
            console.log('Data received:', data); // 받은 데이터 출력
            if (data.length > 0) {
                data.forEach(function (message) {
                    const newMessage = document.createElement('div');
                    newMessage.className = message.sender === currentUserName ? 'message sent' : 'message received';

                    // 메시지 날짜 포맷팅
                    const messageDate = new Date(message.sendDate);
                    const formattedTime = messageDate.toLocaleTimeString('ko-KR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    // 메시지 내용과 시간 표시
                    newMessage.innerHTML = `<strong>${message.sender}</strong>: ${message.message} <br><small>${formattedTime}</small>`;
                    chatMessages.prepend(newMessage);

                    // 가장 오래된 메시지 날짜 갱신
                    if (!oldestMessageDate || messageDate < new Date(oldestMessageDate)) {
                        oldestMessageDate = message.sendDate;
                    }
                });

                // 이전 메시지를 로드한 후 스크롤 위치를 유지
                chatMessages.scrollTop = chatMessages.scrollHeight - previousHeight;
            } else {
                console.log('No previous messages found.');
            }
        })
            .catch((err) => console.error('Error loading previous messages:', err));
    }



    // 이벤트 리스너 설정 함수
    function setupEventListeners() {
        const sendButton = document.getElementById('sendButton');
        const messageInput = document.getElementById('messageInput');
        const chatMessages = document.getElementById('chatMessages');

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        messageInput.addEventListener('input', function() {
            sendButton.disabled = this.value.trim() === '';
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
        chatMessages.addEventListener('scroll', function() {
            if (chatMessages.scrollTop === 0) {
                loadPreviousMessages();
            }
        });
    }

    // DOM이 로드된 후 이벤트 리스너와 연결 설정
    document.addEventListener('DOMContentLoaded', function() {
        connect();
        loadPreviousMessages();
        setupEventListeners();
    });
</script>



<!-- chatRoom -->
</body>
</html>
